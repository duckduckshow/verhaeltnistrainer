<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Verhältnisse – Saft & Wasser (eine Aufgabe pro Seite)</title>

<style>
  * { box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, sans-serif; }
  body { margin:0; background:#f4f4f4; display:flex; justify-content:center; }
  .app{
    background:#fff; max-width: 940px; width:100%;
    margin:12px; padding:12px; border-radius:10px;
    box-shadow:0 2px 8px rgba(0,0,0,.08);
  }
  h1 { margin: 6px 0 10px; text-align:center; font-size:18px; }

  .top { display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
  .meta { font-size:12px; color:#555; }
  .pill { font-size:12px; color:#444; background:#fafafa; border:1px solid #eee; padding:6px 10px; border-radius:999px; }

  .card { margin-top:10px; border:1px solid #e5e5e5; border-radius:12px; padding:12px; background:#fff; }
  .cat { font-size:12px; font-weight:900; color:#444; margin-bottom:6px; }
  .title { font-weight:900; font-size:16px; margin-bottom:8px; }
  .text { font-size:14px; color:#222; line-height:1.35; }
  .text b { font-weight:900; }
  .help {
    margin-top:10px; padding:10px;
    background:#fafafa; border:1px solid #eee; border-radius:12px;
    font-size:13px; color:#333;
  }

  .answers { display:grid; gap:8px; margin-top:12px; }
  .answer {
    border:1px solid #ccc; border-radius:12px; padding:10px;
    background:#fafafa; cursor:pointer; font-size:14px;
  }
  .answer:hover { background:#f0f0f0; }
  .answer.disabled { pointer-events:none; opacity:.95; }
  .answer.correct { background:#d4edda; border-color:#28a745; }
  .answer.wrong { background:#f8d7da; border-color:#dc3545; }

  .feedback { margin-top:10px; font-weight:900; min-height:22px; }
  .controls { margin-top:12px; display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap; }
  .btn {
    padding:8px 12px; border:none; border-radius:12px;
    background:#007bff; color:#fff; cursor:pointer; font-size:13px;
  }
  .btn:hover { background:#0062cc; }
  .btn.secondary { background:#222; }
  .btn.secondary:hover { background:#000; }
  .btn:disabled { opacity:.5; cursor:not-allowed; }

  /* =========================
     VISUALS: Krug + Gläser (immer gleiche Graustufe!)
     - Graustufe NICHT für Verdünnung!
     - NUR Füllstand zeigt Menge
  ========================= */
  .visualRow { margin-top:12px; display:flex; gap:14px; align-items:flex-end; flex-wrap:wrap; }
  .miniCol { display:flex; flex-direction:column; align-items:center; gap:8px; }
  .label { font-size:12px; color:#444; text-align:center; line-height:1.25; }

  .jugWrap { display:flex; flex-direction:column; align-items:center; }
  .jug {
    width:120px; height:150px;
    border:2px solid #333; border-radius:14px 14px 18px 18px;
    position:relative; background:#fff;
  }
  .jug:before{
    content:""; position:absolute; top:-12px; left:18px;
    width:56px; height:22px;
    border:2px solid #333; border-bottom:none;
    border-radius:10px 10px 0 0; background:#fff;
  }
  .jugFill{
    position:absolute; left:9px; right:9px; bottom:9px;
    border-radius:10px;
    border:1px solid #000;
    background: #bdbdbd; /* immer gleich */
    height: 30%;
  }

  .glassRow { display:flex; gap:6px; flex-wrap:wrap; justify-content:center; }
  .glass {
    width:36px; height:78px;
    border:2px solid #333; border-radius:10px;
    position:relative; background:#fff;
  }
  .glass.small{ width:30px; height:68px; border-radius:9px; }
  .glass.large{ width:40px; height:86px; border-radius:11px; }

  .glassFill{
    position:absolute; left:5px; right:5px; bottom:5px;
    border-radius:7px;
    border:1px solid #000;
    background:#bdbdbd; /* immer gleich */
    height: 58%;
  }

  /* kleine Marker "S" und "W" im Glas (neutral, keine Farbe) */
  .marker {
    position:absolute; top:4px; left:0; right:0;
    text-align:center; font-size:11px; font-weight:900; color:#222;
    opacity: .9;
  }

  /* =========================
     SORT: nur ein Drop-Feld
  ========================= */
  .sortWrap { margin-top:10px; display:flex; gap:12px; flex-wrap:wrap; }
  .bank, .target {
    flex:1 1 320px;
    border:2px dashed #aaa; border-radius:12px; padding:10px; background:#fcfcfc;
    min-height:130px;
  }
  .zoneTitle { font-weight:900; margin-bottom:8px; }
  .hint { font-size:12px; color:#555; margin-top:6px; }
  .sortItem {
    border:1px solid #ccc; border-radius:12px; padding:10px; background:#fafafa;
    margin-bottom:8px; cursor:grab; user-select:none;
  }
  .ok { color:#28a745; font-weight:900; }
  .bad { color:#dc3545; font-weight:900; }
</style>
</head>

<body>
<div class="app">
  <h1>Verhältnisse – Saft und Wasser</h1>

  <div class="top">
    <div class="pill">Eine Aufgabe. Dann „Weiter“.</div>
    <div class="meta" id="meta">0 / 0</div>
  </div>

  <div class="card">
    <div class="cat" id="cat"></div>
    <div class="title" id="title"></div>
    <div class="text" id="text"></div>

    <div id="visual" class="visualRow" style="display:none;"></div>

    <div id="answers" class="answers"></div>

    <div id="sortUI" style="display:none;"></div>

    <div class="help" id="help"></div>
    <div class="feedback" id="feedback"></div>

    <div class="controls">
      <button class="btn secondary" id="restartBtn">Neu starten</button>
      <button class="btn" id="nextBtn" disabled>Weiter</button>
    </div>
  </div>
</div>

<script>
/* =========================
   Helpers
========================= */
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function strength(ing, water){
  const total = ing + water;
  return total <= 0 ? 0 : ing / total;
}
function gcd(a,b){ a=Math.abs(a); b=Math.abs(b); while(b){ [a,b]=[b,a%b]; } return a||1; }
function canon(ing, water){
  const g = gcd(ing, water);
  return `${ing/g}:${water/g}`;
}

/* =========================
   Visual system
   - ALWAYS SAME GRAY FILL
   - Fill HEIGHT shows total amount (units)
   - Glass icons show count and (optional) size type
   - Markers: S (Saft) / W (Wasser) only as letters
========================= */

/*
  A mix is described as:
  {
    saft: { small: n, large: n }  // large = 2 units
    wasser:{ small: n, large: n }
    mode: "equalSizeOnly" | "smallLarge"
  }
*/
function unitsFromMix(mix){
  const sSmall = (mix.saft?.small || 0);
  const sLarge = (mix.saft?.large || 0);
  const wSmall = (mix.wasser?.small || 0);
  const wLarge = (mix.wasser?.large || 0);
  // small = 1 unit, large = 2 units
  return (sSmall*1 + sLarge*2 + wSmall*1 + wLarge*2);
}

function glassIconsHTML(type, size, count){
  // type: "S" or "W"
  // size: "small" or "large"
  let out = "";
  for(let i=0;i<count;i++){
    out += `
      <div class="glass ${size}">
        <div class="marker">${type}</div>
        <div class="glassFill"></div>
      </div>`;
  }
  return out;
}

function renderMixGlasses(mix){
  const sSmall = (mix.saft?.small || 0);
  const sLarge = (mix.saft?.large || 0);
  const wSmall = (mix.wasser?.small || 0);
  const wLarge = (mix.wasser?.large || 0);

  let icons = "";
  // keep grouping simple: Saft then Wasser
  icons += glassIconsHTML("S","small",sSmall);
  icons += glassIconsHTML("S","large",sLarge);
  icons += glassIconsHTML("W","small",wSmall);
  icons += glassIconsHTML("W","large",wLarge);

  // if no size types used (equal size only), default to small icons
  if(icons.trim()===""){
    icons = "";
  }
  return `<div class="glassRow">${icons}</div>`;
}

function renderTwoJugs(container, mixA, mixB){
  const unitsA = unitsFromMix(mixA);
  const unitsB = unitsFromMix(mixB);
  const maxUnits = Math.max(unitsA, unitsB, 1);

  // map units -> fill height 15%..85% (avoid extreme empty/full)
  function fillPct(units){
    const t = units / maxUnits;
    return (15 + t * 70); // 15..85
  }

  const aPct = fillPct(unitsA).toFixed(1);
  const bPct = fillPct(unitsB).toFixed(1);

  // Build label text for clarity
  function labelLines(mix){
    const sSmall = mix.saft?.small || 0;
    const sLarge = mix.saft?.large || 0;
    const wSmall = mix.wasser?.small || 0;
    const wLarge = mix.wasser?.large || 0;

    // For phase 1 (equal glasses): we store as small counts only.
    // For phase 2: show "groß" and "klein" counts
    const lines = [];
    if(sLarge>0 || wLarge>0){
      // small/large mode
      if(sLarge>0) lines.push(`${sLarge} großes Glas Saft`);
      if(sSmall>0) lines.push(`${sSmall} kleines Glas Saft`);
      if(wLarge>0) lines.push(`${wLarge} großes Glas Wasser`);
      if(wSmall>0) lines.push(`${wSmall} kleines Glas Wasser`);
    } else {
      // equal size mode (all are "Gläser")
      if(sSmall>0) lines.push(`${sSmall} Gläser Saft`);
      if(wSmall>0) lines.push(`${wSmall} Gläser Wasser`);
    }
    return lines.join("<br>");
  }

  container.innerHTML = `
    <div class="miniCol">
      <div class="jugWrap">
        <div class="jug">
          <div class="jugFill" style="height:${aPct}%"></div>
        </div>
      </div>
      ${renderMixGlasses(mixA)}
      <div class="label"><b>Krug A</b><br>${labelLines(mixA)}</div>
    </div>

    <div class="miniCol">
      <div class="jugWrap">
        <div class="jug">
          <div class="jugFill" style="height:${bPct}%"></div>
        </div>
      </div>
      ${renderMixGlasses(mixB)}
      <div class="label"><b>Krug B</b><br>${labelLines(mixB)}</div>
    </div>
  `;
}

/* =========================
   Steps (eine Aufgabe pro Screen)
   Hinweis: Visuals zeigen NUR MENGE (Füllstand), nie Verdünnung.
========================= */
const steps = [
  {
    type:"intro",
    cat:"Einführung",
    title:"So arbeiten wir",
    text: `
      <p><b>Ich mische Saft und Wasser in einen Krug.</b></p>
      <p>Manchmal schmeckt es <b>gleich</b>.<br>
      Dann ist es <b>gleich gemischt</b>.</p>
      <p><b>Merksatz:</b><br>
      Zwei Mischungen <b>schmecken gleich / sind gleich gemischt</b>, wenn das Verhältnis gleich ist.</p>
    `,
    help:`Tipp: Die Bilder zeigen hier nur: <b>wie viel</b> im Krug ist (Füllstand).`,
  },

  /* =========================
     PHASE 1: gleiche Gläser
     - Visuals: Füllstand unterschiedlich, Graustufe gleich
     - Ziel: Menge kann anders sein, trotzdem gleich gemischt
  ========================= */
  {
    type:"mc",
    cat:"Level 1 – gleiche Gläser (Menge kann verschieden sein)",
    title:"Aufgabe 1",
    text: `
      <p>Ich mische in einen Krug (Krug A):<br>
      <b>2 Gläser Saft</b> und <b>3 Gläser Wasser</b>.</p>
      <p>Ich mische in einen Krug (Krug B):<br>
      <b>4 Gläser Saft</b> und <b>6 Gläser Wasser</b>.</p>
      <p><b>Welche Aussage stimmt?</b></p>
    `,
    showVisual:true,
    mixA:{ saft:{small:2}, wasser:{small:3} },
    mixB:{ saft:{small:4}, wasser:{small:6} },
    answers:[
      {t:"Krug B schmeckt gleich / ist gleich gemischt wie Krug A.", ok:true},
      {t:"Krug B schmeckt stärker / ist stärker gemischt als Krug A.", ok:false},
      {t:"Krug B schmeckt schwächer / ist schwächer gemischt als Krug A.", ok:false},
      {t:"Man kann das nicht sagen.", ok:false}
    ],
    help:`Hier ist in Krug B mehr drin. Das kann trotzdem <b>gleich gemischt</b> sein.`,
  },
  {
    type:"yesno",
    cat:"Level 1 – gleiche Gläser (Menge ist nicht das Wichtigste)",
    title:"Aufgabe 2",
    text: `
      <p>Ich mische in einen Krug (Krug A):<br>
      <b>1 Glas Saft</b> und <b>2 Gläser Wasser</b>.</p>
      <p>Ich mische in einen Krug (Krug B):<br>
      <b>2 Gläser Saft</b> und <b>4 Gläser Wasser</b>.</p>
      <p><b>Schmecken die Mischungen gleich / sind sie gleich gemischt?</b></p>
    `,
    showVisual:true,
    mixA:{ saft:{small:1}, wasser:{small:2} },
    mixB:{ saft:{small:2}, wasser:{small:4} },
    correctYes:true,
    help:`Auch wenn Krug B voller ist: Das Verhältnis kann gleich sein.`,
  },
  {
    type:"yesno",
    cat:"Level 1 – Falle (gleich viel im Krug, aber anders gemischt)",
    title:"Aufgabe 3",
    text: `
      <p>Ich mische in einen Krug (Krug A):<br>
      <b>2 Gläser Saft</b> und <b>4 Gläser Wasser</b>.</p>
      <p>Ich mische in einen Krug (Krug B):<br>
      <b>3 Gläser Saft</b> und <b>3 Gläser Wasser</b>.</p>
      <p><b>Schmecken die Mischungen gleich / sind sie gleich gemischt?</b></p>
    `,
    showVisual:true,
    mixA:{ saft:{small:2}, wasser:{small:4} }, // total 6
    mixB:{ saft:{small:3}, wasser:{small:3} }, // total 6 (gleich voll)
    correctYes:false,
    help:`Hier ist gleich viel im Krug. Trotzdem kann es <b>anders gemischt</b> sein.`,
  },

  /* =========================
     PHASE 2: große & kleine Gläser
     - Visuals: Füllstand zeigt Einheiten
     - Beispiel: 1 großes + 2 große vs 2 kleine + 4 kleine (Menge UND Verhältnis gleich)
  ========================= */
  {
    type:"yesno",
    cat:"Level 1 – große und kleine Gläser (gleich viel UND gleich gemischt)",
    title:"Aufgabe 4",
    text: `
      <p>Ich mische in einen Krug (Krug A):<br>
      <b>1 großes Glas Saft</b> und <b>2 große Gläser Wasser</b>.</p>
      <p>Ich mische in einen Krug (Krug B):<br>
      <b>2 kleine Gläser Saft</b> und <b>4 kleine Gläser Wasser</b>.</p>
      <p><b>Schmecken die Mischungen gleich / sind sie gleich gemischt?</b></p>
    `,
    showVisual:true,
    // large = 2 units, small = 1 unit
    mixA:{ saft:{large:1}, wasser:{large:2} },   // units: 2 + 4 = 6
    mixB:{ saft:{small:2}, wasser:{small:4} },   // units: 2 + 4 = 6
    correctYes:true,
    help:`Große und kleine Gläser können trotzdem <b>gleich viel</b> ergeben.`,
  },
  {
    type:"mc",
    cat:"Level 1 – große und kleine Gläser",
    title:"Aufgabe 5",
    text: `
      <p>Ich mische in einen Krug (Krug A):<br>
      <b>1 großes Glas Saft</b> und <b>3 große Gläser Wasser</b>.</p>
      <p>Ich mische in einen Krug (Krug B):<br>
      <b>2 kleine Gläser Saft</b> und <b>4 kleine Gläser Wasser</b>.</p>
      <p><b>Welche Aussage stimmt?</b></p>
    `,
    showVisual:true,
    mixA:{ saft:{large:1}, wasser:{large:3} },  // units: 2 + 6 = 8 => Verhältnis 1:3
    mixB:{ saft:{small:2}, wasser:{small:4} },  // units: 2 + 4 = 6 => Verhältnis 1:2 (anders)
    answers:[
      {t:"Krug B schmeckt gleich / ist gleich gemischt wie Krug A.", ok:false},
      {t:"Krug B schmeckt stärker / ist stärker gemischt als Krug A.", ok:true},
      {t:"Krug B schmeckt schwächer / ist schwächer gemischt als Krug A.", ok:false},
      {t:"Man kann das nicht sagen.", ok:false}
    ],
    help:`Nicht nur die Menge ist wichtig. Wichtig ist: Saft zu Wasser.`,
  },

  /* =========================
     LEVEL 2: Transfer (ohne Visuals)
     - weiter die gleiche Sprache
  ========================= */
  {
    type:"mc",
    cat:"Level 2 – Übertragen (ohne Bilder)",
    title:"Aufgabe 6",
    text: `
      <p>Ich mische in einen Krug:<br>
      <b>1 Glas Saft</b> und <b>2 Gläser Wasser</b>.</p>
      <p><b>Welche Mischung schmeckt gleich / ist gleich gemischt?</b></p>
    `,
    showVisual:false,
    answers:[
      {t:"2 Gläser Saft und 4 Gläser Wasser", ok:true},
      {t:"2 Gläser Saft und 3 Gläser Wasser", ok:false},
      {t:"1 Glas Saft und 3 Gläser Wasser", ok:false},
      {t:"3 Gläser Saft und 4 Gläser Wasser", ok:false}
    ],
    help:`Gleich gemischt bedeutet: gleich viel Saft zu Wasser.`,
  },
  {
    type:"yesno",
    cat:"Level 2 – Übertragen (ohne Bilder)",
    title:"Aufgabe 7",
    text: `
      <p>Ich mische in einen Krug (A):<br>
      <b>3 Gläser Saft</b> und <b>9 Gläser Wasser</b>.</p>
      <p>Ich mische in einen Krug (B):<br>
      <b>1 Glas Saft</b> und <b>3 Gläser Wasser</b>.</p>
      <p><b>Schmecken die Mischungen gleich / sind sie gleich gemischt?</b></p>
    `,
    showVisual:false,
    correctYes:true,
    help:`3:9 ist wie 1:3 → gleich gemischt.`,
  },

  /* =========================
     Zusatz: Farbe mit Löffeln (wie besprochen)
     - gleiche Idee, andere Einheit
  ========================= */
  {
    type:"mc",
    cat:"Zusatz – Farbe (mit Löffeln)",
    title:"Aufgabe 8",
    text: `
      <p>Ich mische Farbe mit Wasser.</p>
      <p>Ich mische:<br>
      <b>1 Löffel Farbe</b> und <b>3 Löffel Wasser</b>.</p>
      <p><b>Welche Mischung sieht gleich aus / ist gleich gemischt?</b></p>
    `,
    showVisual:false,
    answers:[
      {t:"2 Löffel Farbe und 6 Löffel Wasser", ok:true},
      {t:"2 Löffel Farbe und 5 Löffel Wasser", ok:false},
      {t:"1 Löffel Farbe und 5 Löffel Wasser", ok:false},
      {t:"3 Löffel Farbe und 6 Löffel Wasser", ok:false}
    ],
    help:`Gleiche Idee: Gleich gemischt = gleiches Verhältnis.`,
  },

  /* =========================
     SORT: one drop field
  ========================= */
  {
    type:"sort",
    cat:"Sortieren",
    title:"Aufgabe 9",
    text: `
      <p><b>Ordne von stark nach schwach.</b></p>
      <p>Ziehe alle Karten in das Feld „Meine Reihenfolge“.<br>
      Oben = schmeckt stärker / ist stärker gemischt.<br>
      Unten = schmeckt schwächer / ist schwächer gemischt.</p>
    `,
    showVisual:false,
    sortItems: [
      {id:"s1", text:"2 Gläser Saft und 2 Gläser Wasser", ing:2, water:2},
      {id:"s2", text:"1 Glas Saft und 2 Gläser Wasser", ing:1, water:2},
      {id:"s3", text:"1 Glas Saft und 4 Gläser Wasser", ing:1, water:4},
      {id:"s4", text:"1 Glas Saft und 6 Gläser Wasser", ing:1, water:6},
    ],
    help:`Tipp: „Mehr Saft pro Wasser“ = stärker.`,
  }
];

/* =========================
   UI state
========================= */
let stepIndex = 0;
let answered = false;

const metaEl = document.getElementById("meta");
const catEl = document.getElementById("cat");
const titleEl = document.getElementById("title");
const textEl = document.getElementById("text");
const helpEl = document.getElementById("help");
const answersEl = document.getElementById("answers");
const feedbackEl = document.getElementById("feedback");
const nextBtn = document.getElementById("nextBtn");
const restartBtn = document.getElementById("restartBtn");
const visualEl = document.getElementById("visual");
const sortUI = document.getElementById("sortUI");

function setMeta(){ metaEl.textContent = `${stepIndex + 1} / ${steps.length}`; }

function clearScreen(){
  answersEl.innerHTML = "";
  feedbackEl.textContent = "";
  answered = false;
  nextBtn.disabled = true;
  visualEl.style.display = "none";
  visualEl.innerHTML = "";
  sortUI.style.display = "none";
  sortUI.innerHTML = "";
}

function renderStep(){
  clearScreen();
  setMeta();

  const s = steps[stepIndex];
  catEl.textContent = s.cat || "";
  titleEl.textContent = s.title || "";
  textEl.innerHTML = s.text || "";
  helpEl.innerHTML = s.help || "";

  if(s.type === "intro"){
    nextBtn.disabled = false;
    return;
  }

  if(s.showVisual && s.mixA && s.mixB){
    visualEl.style.display = "flex";
    renderTwoJugs(visualEl, s.mixA, s.mixB);
  }

  if(s.type === "mc"){
    renderMC(s);
  } else if(s.type === "yesno"){
    renderYesNo(s);
  } else if(s.type === "sort"){
    renderSort(s);
  }
}

function renderMC(s){
  const order = shuffle(s.answers.map((_,i)=>i));

  order.forEach((idx) => {
    const a = s.answers[idx];
    const btn = document.createElement("div");
    btn.className = "answer";
    btn.textContent = a.t;

    btn.onclick = () => {
      if(answered) return;
      answered = true;

      [...answersEl.children].forEach(el => el.classList.add("disabled"));

      if(a.ok){
        btn.classList.add("correct");
        feedbackEl.textContent = "Richtig.";
      } else {
        btn.classList.add("wrong");
        feedbackEl.textContent = "Falsch.";
        // mark correct
        [...answersEl.children].forEach((el) => {
          const txt = el.textContent;
          const found = s.answers.find(x => x.t === txt);
          if(found && found.ok) el.classList.add("correct");
        });
      }
      nextBtn.disabled = false;
    };

    answersEl.appendChild(btn);
  });
}

function renderYesNo(s){
  const opts = shuffle([
    {t:"Ja", ok: s.correctYes === true},
    {t:"Nein", ok: s.correctYes === false}
  ]);

  opts.forEach(o => {
    const btn = document.createElement("div");
    btn.className = "answer";
    btn.textContent = o.t;

    btn.onclick = () => {
      if(answered) return;
      answered = true;

      [...answersEl.children].forEach(el => el.classList.add("disabled"));

      if(o.ok){
        btn.classList.add("correct");
        feedbackEl.textContent = "Richtig.";
      } else {
        btn.classList.add("wrong");
        feedbackEl.textContent = "Falsch.";
        // mark correct option
        [...answersEl.children].forEach(el => {
          if((el.textContent==="Ja" && s.correctYes) || (el.textContent==="Nein" && !s.correctYes)){
            el.classList.add("correct");
          }
        });
      }
      nextBtn.disabled = false;
    };

    answersEl.appendChild(btn);
  });
}

/* =========================
   Sort UI (single drop field)
========================= */
let dragEl = null;

function enableDnD(container){
  container.addEventListener("dragstart", (e) => {
    const item = e.target.closest(".sortItem");
    if(!item) return;
    dragEl = item;
    e.dataTransfer.effectAllowed = "move";
  });

  container.addEventListener("dragover", (e) => {
    e.preventDefault();
    const zone = e.target.closest(".bank, .target");
    if(!zone || !dragEl) return;

    const overItem = e.target.closest(".sortItem");
    if(overItem && overItem.parentElement === zone && overItem !== dragEl){
      const rect = overItem.getBoundingClientRect();
      const after = (e.clientY - rect.top) > rect.height/2;
      if(after) overItem.after(dragEl);
      else overItem.before(dragEl);
    } else if(!overItem){
      zone.appendChild(dragEl);
    }
  });

  container.addEventListener("drop", (e) => {
    e.preventDefault();
    dragEl = null;
  });

  container.addEventListener("dragend", () => dragEl = null);
}

function renderSort(s){
  sortUI.style.display = "block";

  const wrap = document.createElement("div");
  wrap.className = "sortWrap";

  const bank = document.createElement("div");
  bank.className = "bank";
  bank.innerHTML = `<div class="zoneTitle">Karten</div><div class="hint">Ziehe alle Karten in „Meine Reihenfolge“.</div>`;

  const target = document.createElement("div");
  target.className = "target";
  target.innerHTML = `<div class="zoneTitle">Meine Reihenfolge</div><div class="hint">Oben = stärker, unten = schwächer.</div>`;

  // items
  const items = shuffle(s.sortItems.slice());
  items.forEach(it => {
    const div = document.createElement("div");
    div.className = "sortItem";
    div.draggable = true;
    div.textContent = it.text;
    div.dataset.ing = it.ing;
    div.dataset.water = it.water;
    bank.appendChild(div);
  });

  wrap.appendChild(bank);
  wrap.appendChild(target);

  const checkRow = document.createElement("div");
  checkRow.style.marginTop = "10px";
  checkRow.style.display = "flex";
  checkRow.style.gap = "8px";
  checkRow.style.flexWrap = "wrap";
  checkRow.style.alignItems = "center";

  const checkBtn = document.createElement("button");
  checkBtn.className = "btn";
  checkBtn.textContent = "Prüfen";

  const result = document.createElement("div");
  result.style.fontWeight = "900";

  checkBtn.onclick = () => {
    const targetItems = [...target.querySelectorAll(".sortItem")];
    if(targetItems.length !== s.sortItems.length){
      result.className = "bad";
      result.textContent = "Noch nicht. Ziehe zuerst alle Karten in „Meine Reihenfolge“.";
      nextBtn.disabled = true;
      return;
    }

    const correctSorted = s.sortItems
      .slice()
      .sort((a,b) => strength(b.ing,b.water) - strength(a.ing,a.water))
      .map(x => `${x.ing}:${x.water}`);

    const current = targetItems.map(el => `${el.dataset.ing}:${el.dataset.water}`);

    const ok = correctSorted.join("|") === current.join("|");
    if(ok){
      result.className = "ok";
      result.textContent = "✅ Richtig geordnet.";
      nextBtn.disabled = false;
    } else {
      result.className = "bad";
      result.textContent = "❌ Noch nicht. Tipp: Mehr Saft pro Wasser = stärker.";
      nextBtn.disabled = true;
    }
  };

  checkRow.appendChild(checkBtn);
  checkRow.appendChild(result);

  sortUI.appendChild(wrap);
  sortUI.appendChild(checkRow);

  enableDnD(sortUI);
}

/* =========================
   Navigation
========================= */
nextBtn.onclick = () => {
  stepIndex++;
  if(stepIndex >= steps.length) stepIndex = 0;
  renderStep();
};
restartBtn.onclick = () => {
  stepIndex = 0;
  renderStep();
};

renderStep();
</script>
</body>
</html>
